# üîê JANO - MICROSERVICIO CENTRALIZADO DE VALIDACI√ìN

**Concepto**: Un √∫nico microservicio que valida autenticaci√≥n y autorizaci√≥n para TODOS los otros microservicios.

---

## üìä ARQUITECTURA ACTUAL vs PROPUESTA

### ‚ùå ACTUAL (Validaci√≥n Distribuida - NO √ìPTIMO)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Auth Microservice     ‚îÇ
‚îÇ  - Genera JWT           ‚îÇ
‚îÇ  - OTP validation       ‚îÇ
‚îÇ  - Tokens               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Users Microservice    ‚îÇ
‚îÇ  - Credenciales         ‚îÇ
‚îÇ  - JANO rules?          ‚îÇ
‚îÇ  - Rate limiting?       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   OTP Microservice      ‚îÇ
‚îÇ  - OTP codes            ‚îÇ
‚îÇ  - Validaci√≥n?          ‚îÇ
‚îÇ  - Rate limiting?       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Management App MS     ‚îÇ
‚îÇ  - ¬øC√≥mo valida?        ‚îÇ
‚îÇ  - ¬øQu√© reglas?         ‚îÇ
‚îÇ  - ¬øRate limit?         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚ùå PROBLEMA: Cada servicio hace su propia validaci√≥n
‚ùå PROBLEMA: No hay consistencia de reglas
‚ùå PROBLEMA: Duplicaci√≥n de l√≥gica
‚ùå PROBLEMA: Dif√≠cil mantener
```

---

### ‚úÖ PROPUESTA (JANO Centralizado)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  JANO MICROSERVICE (Central)                   ‚îÇ
‚îÇ                        (Puerto 8002)                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  VALIDACI√ìN DE TOKENS & AUTORIZACI√ìN                    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Valida JWT con firmas p√∫blicas                       ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Verifica roles y permisos                            ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Eval√∫a reglas de seguridad                           ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  REGLAS DE SEGURIDAD (jano_security_rules)              ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Rate limiting (requests por minuto)                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - IP whitelist                                         ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - MFA policies                                         ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Password policies                                    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Session expiry                                       ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Command execution rules                              ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  CACH√â DE PERMISOS & GRUPOS                             ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Cache de usuario + roles + grupos (10 min)           ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Cache de restricciones por recurso                   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Cache de aplicaciones y m√≥dulos                      ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  AUDITOR√çA & LOGGING                                    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Registro de violaciones (jano_rule_violations)       ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Logs de acceso negado                                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Estad√≠sticas de seguridad                            ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
   ‚ñ≤            ‚ñ≤            ‚ñ≤           
   ‚îÇ Valida     ‚îÇ Valida     ‚îÇ Valida  
‚îå‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îê    
‚îÇAuth ‚îÇ      ‚îÇUsers‚îÇ      ‚îÇ OTP ‚îÇ     
‚îÇ(8001)     ‚îÇ(8006)      ‚îÇ(8003)     
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     
```

---

## üîÑ FLUJO DE VALIDACI√ìN EN JANO

### Cuando CUALQUIER microservicio recibe una petici√≥n:

```
1. Petici√≥n llega al Microservicio
   ‚îî‚îÄ> GET /api/users/1
       Headers: Authorization: Bearer eyJhbGc...

2. Microservicio (Auth, Users, OTP, etc.) llama a JANO
   ‚îî‚îÄ> POST http://jano_microservice:8002/api/validate
       {
         "token": "eyJhbGc...",
         "endpoint": "/api/users/1",
         "method": "GET",
         "ip_address": "192.168.1.100",
         "user_agent": "Mozilla/5.0...",
         "request_data": {...}
       }

3. JANO valida en ESTE ORDEN:
   
   ‚úÖ ETAPA 1: AUTENTICACI√ìN
      ‚îî‚îÄ> ¬øEl token es v√°lido?
          - Verifica firma del JWT
          - Comprueba que no est√© expirado
          - Verifica que no est√© revocado
      
      Si ‚úÖ Contin√∫a a ETAPA 2
      Si ‚ùå Retorna 401 Unauthorized

   ‚úÖ ETAPA 2: AUTORIZACI√ìN (URL + M√©todo)
      ‚îî‚îÄ> ¬øEl usuario puede acceder a este endpoint?
          - Lee tabla: jano_security_rules (restricciones)
          - Mapea URL: /api/users/* 
          - Valida m√©todo: GET
          - Verifica grupos del usuario
      
      Si ‚úÖ Contin√∫a a ETAPA 3
      Si ‚ùå Retorna 403 Forbidden

   ‚úÖ ETAPA 3: EVALUACI√ìN DE REGLAS DE SEGURIDAD
      ‚îî‚îÄ> Rate limiting
          - ¬øQu√© IP? ‚Üí ¬øCu√°ntas requests en el √∫ltimo minuto?
          - Si >= 100 req/min ‚Üí BLOQUEA
          - Registra violaci√≥n en: jano_rule_violations
      
      ‚îî‚îÄ> Otras validaciones
          - ¬øIP en whitelist?
          - ¬øComando permitido para este rol?
          - ¬øCartera de clientes?
          - ¬øNivel de seguridad?
      
      Si ‚úÖ Contin√∫a a ETAPA 4
      Si ‚ùå Retorna 429 Too Many Requests o 403 Forbidden

   ‚úÖ ETAPA 4: RETORNA PERMISO AL MICROSERVICIO
      ‚îî‚îÄ> Retorna JSON con permisos validados:
          {
            "authorized": true,
            "user": {
              "user_id": "78de8e0b-...",
              "username": "juan.perez",
              "email": "juan.perez@siata.gov.co",
              "role": "user_siata",
              "groups": ["hidrologia", "development"],
              "permissions": ["read", "write"]
            },
            "validation": {
              "stage_1_authentication": "PASS",
              "stage_2_authorization": "PASS",
              "stage_3_rules": "PASS"
            },
            "metadata": {
              "token_expires_at": "2025-10-19T23:00:00Z",
              "cached": true,
              "cache_ttl": 600
            }
          }

4. Microservicio recibe respuesta
   ‚îî‚îÄ> Si authorized === true
       ‚îú‚îÄ> Contin√∫a con la l√≥gica de negocio
       ‚îú‚îÄ> Accede a la BD
       ‚îú‚îÄ> Procesa la petici√≥n
       ‚îî‚îÄ> Retorna respuesta al cliente
   
   ‚îî‚îÄ> Si authorized === false
       ‚îú‚îÄ> Retorna error (401, 403, 429)
       ‚îî‚îÄ> NO accede a la BD
```

---

## üìã ENDPOINTS DE JANO

### 1. **POST /api/validate** (Principal)
**Prop√≥sito**: Validar token y autorizaci√≥n

```
Petici√≥n:
POST http://jano_microservice:8002/api/validate
{
  "token": "eyJhbGc...",
  "endpoint": "/api/users/1",
  "method": "GET",
  "ip_address": "192.168.1.100",
  "user_agent": "Mozilla/5.0...",
  "request_data": {} (opcional)
}

Respuesta ‚úÖ (Autorizado):
{
  "authorized": true,
  "user": {
    "user_id": "...",
    "username": "juan.perez",
    "role": "user_siata",
    "groups": ["hidrologia"],
    "permissions": ["read", "write"]
  },
  "validation_stages": [
    {"stage": "authentication", "result": "PASS"},
    {"stage": "authorization", "result": "PASS"},
    {"stage": "rules_evaluation", "result": "PASS"}
  ]
}

Respuesta ‚ùå (No autorizado):
{
  "authorized": false,
  "error": "RATE_LIMIT_EXCEEDED",
  "message": "100 requests per minute exceeded",
  "retry_after": 45
}
```

### 2. **POST /api/validate-command** (Para comandos complejos)
**Prop√≥sito**: Validar ejecuci√≥n de comandos espec√≠ficos

```
Petici√≥n:
POST http://jano_microservice:8002/api/validate-command
{
  "token": "eyJhbGc...",
  "command": "task.save",
  "resource": "/api/tasks",
  "ip_address": "192.168.1.100"
}

Respuesta:
{
  "authorized": true,
  "command": "task.save",
  "restrictions_matched": {
    "rule": "COMMAND_RULE_001",
    "allowed_roles": ["root", "user_siata"],
    "allowed_commands": ["*"]
  }
}
```

### 3. **GET /api/rules** (Consultar reglas)
**Prop√≥sito**: Obtener todas las reglas de seguridad

```
GET http://jano_microservice:8002/api/rules

Respuesta:
{
  "rules": [
    {
      "rule_id": "...",
      "rule_name": "Rate limiting de API",
      "rule_type": "rate_limit",
      "config": {
        "requests_per_minute": 100,
        "burst_size": 150
      },
      "severity": "high",
      "is_active": true
    },
    ...
  ]
}
```

### 4. **POST /api/violations** (Log de violaciones)
**Prop√≥sito**: Registrar violaciones de seguridad

```
POST http://jano_microservice:8002/api/violations
{
  "user_id": "...",
  "rule_id": "...",
  "violation_type": "RATE_LIMIT_EXCEEDED",
  "endpoint": "/api/data/stations",
  "ip_address": "203.0.113.42",
  "was_blocked": true
}

Respuesta:
{
  "violation_id": "...",
  "recorded_at": "2025-10-19T23:00:00Z"
}
```

### 5. **GET /api/cache-status** (Estado del cach√©)
**Prop√≥sito**: Monitoreo

```
GET http://jano_microservice:8002/api/cache-status

Respuesta:
{
  "cache": {
    "total_entries": 543,
    "memory_usage_mb": 12.5,
    "hit_rate": 0.87,
    "ttl_seconds": 600
  }
}
```

---

## üèóÔ∏è ESTRUCTURA INTERNA DE JANO

```
jano_microservice/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ application/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dtos/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ validate_request_dto.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ validate_response_dto.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ rule_dto.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ use_cases/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ validate_token_use_case.py
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ authorize_user_use_case.py
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ evaluate_security_rules_use_case.py
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ check_rate_limiting_use_case.py
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ log_violation_use_case.py
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user_entity.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ token_entity.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rule_entity.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ violation_entity.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ exceptions/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ jano_exceptions.py
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ports/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ token_validation_port.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user_repository_port.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rule_repository_port.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ cache_port.py
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ jwt_validator_service.py (valida tokens)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ authorization_service.py (valida permisos)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rate_limiter_service.py (rate limiting)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cache_service.py (cach√© centralizado)
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ rule_evaluator_service.py (eval√∫a reglas)
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ token_parser.py
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ rule_matcher.py (regex para URL)
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ permission_checker.py
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ infrastructure/
‚îÇ       ‚îú‚îÄ‚îÄ adapters/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ db/
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user_repository.py (lee de siata_auth.users)
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rule_repository.py (lee de jano_security_rules)
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ violation_repository.py (escribe en jano_rule_violations)
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ token_repository.py (lee de auth_tokens)
‚îÇ       ‚îÇ   ‚îÇ
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ cache/
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ redis_cache_adapter.py
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ in_memory_cache_adapter.py
‚îÇ       ‚îÇ   ‚îÇ
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ controllers/
‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ jano_controller.py
‚îÇ       ‚îÇ
‚îÇ       ‚îî‚îÄ‚îÄ config/
‚îÇ           ‚îú‚îÄ‚îÄ database_config.py
‚îÇ           ‚îú‚îÄ‚îÄ cache_config.py
‚îÇ           ‚îî‚îÄ‚îÄ security_config.py
‚îÇ
‚îú‚îÄ‚îÄ main.py
‚îú‚îÄ‚îÄ requirements.txt
‚îî‚îÄ‚îÄ Dockerfile
```

---

## üîÑ FLUJO ENTRE MICROSERVICIOS Y JANO

### Ejemplo: Petici√≥n a Users Microservice

```
CLIENTE
‚îÇ
‚îú‚îÄ> POST /api/users/1
‚îÇ   Headers: Authorization: Bearer eyJhbGc...
‚îÇ
‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Users Microservice (8006)  ‚îÇ
‚îÇ  (Recibe petici√≥n)          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚îÇ (ANTES de procesar)
           ‚îÇ Llama a JANO
           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  JANO Microservice (8002)   ‚îÇ
‚îÇ  POST /api/validate         ‚îÇ
‚îÇ  {                          ‚îÇ
‚îÇ    "token": "eyJhbGc...",  ‚îÇ
‚îÇ    "endpoint": "/api/users" ‚îÇ
‚îÇ    "method": "POST",        ‚îÇ
‚îÇ    "ip_address": "192..." ‚îÇ
‚îÇ  }                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚îÇ VALIDA:
           ‚îÇ 1. Token JWT v√°lido? ‚úÖ
           ‚îÇ 2. Usuario autorizado? ‚úÖ
           ‚îÇ 3. Rate limit ok? ‚úÖ
           ‚îÇ 4. Otras reglas? ‚úÖ
           ‚îÇ
           ‚îÇ Retorna:
           ‚ñº
    {
      "authorized": true,
      "user": {...},
      "validation_stages": [...]
    }
           ‚îÇ
           ‚îÇ
           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Users Microservice (8006)  ‚îÇ
‚îÇ  (Recibe respuesta de JANO) ‚îÇ
‚îÇ  authorized === true?       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
     ‚úÖ YES ‚îÇ
           ‚îÇ Contin√∫a con l√≥gica de negocio
           ‚îÇ - Accede a BD
           ‚îÇ - Procesa datos
           ‚îÇ - Retorna respuesta
           ‚ñº
    RESPUESTA AL CLIENTE
    {
      "user_id": 1,
      "name": "Juan",
      "email": "juan@..."
    }
```

---

## üíæ TABLAS QUE USA JANO

### Desde `siata_auth` schema:

1. **users** (lee)
   - Obtiene roles, grupos, permisos

2. **auth_tokens** (lee)
   - Valida que el token existe y no est√© revocado

3. **jano_security_rules** (lee)
   - Obtiene reglas de seguridad configuradas

4. **jano_rule_violations** (escribe)
   - Registra violaciones cuando alguien intenta acceder sin permisos

5. **sessions** (lee)
   - Valida sesiones activas

6. **teams** (lee)
   - Obtiene grupos del usuario

7. **applications** (lee)
   - Valida aplicaciones autorizadas

8. **modules** (lee)
   - Valida acceso a m√≥dulos

9. **module_permissions** (lee)
   - Obtiene permisos espec√≠ficos por rol/equipo

---

## ‚ö° CACH√â EN JANO (CR√çTICO)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         CACH√â DE JANO (10 minutos TTL)         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                ‚îÇ
‚îÇ Clave: user:{user_id}                         ‚îÇ
‚îÇ Valor:                                        ‚îÇ
‚îÇ {                                             ‚îÇ
‚îÇ   "user_id": "...",                          ‚îÇ
‚îÇ   "username": "juan",                        ‚îÇ
‚îÇ   "role": "user_siata",                      ‚îÇ
‚îÇ   "groups": ["hidrologia", "dev"],           ‚îÇ
‚îÇ   "permissions": ["read", "write"],          ‚îÇ
‚îÇ   "cached_at": 2025-10-19T23:00:00,          ‚îÇ
‚îÇ   "expires_at": 2025-10-19T23:10:00          ‚îÇ
‚îÇ }                                             ‚îÇ
‚îÇ                                               ‚îÇ
‚îÇ Clave: rule:{rule_id}                         ‚îÇ
‚îÇ Valor: {...regla configurada...}             ‚îÇ
‚îÇ                                               ‚îÇ
‚îÇ Clave: rate_limit:{ip}                        ‚îÇ
‚îÇ Valor: {requests: 95, window_end: ...}       ‚îÇ
‚îÇ                                               ‚îÇ
‚îÇ Clave: endpoint:{endpoint}:{method}          ‚îÇ
‚îÇ Valor: {matched_rule_id: "...", ...}         ‚îÇ
‚îÇ                                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

IMPORTANTE:
- Si cambias un usuario de grupo ‚Üí espera 10 min
- Si cambias una regla ‚Üí espera 10 min
- Si cambias permisos ‚Üí espera 10 min
- Por eso Caroline menciona el cache en su explicaci√≥n
```

---

## üîå C√ìMO LOS OTROS MICROSERVICIOS INTEGRAN JANO

### En cada microservicio (Auth, Users, OTP, Management):

```python
# En el controlador o middleware

from requests import post

class AuthMiddleware:
    async def __call__(self, request):
        # 1. Obtener token del header
        token = request.headers.get("Authorization", "").replace("Bearer ", "")
        
        # 2. LLAMAR A JANO para validar
        response = post(
            "http://jano_microservice:8002/api/validate",
            json={
                "token": token,
                "endpoint": request.url.path,
                "method": request.method,
                "ip_address": request.client.host,
                "user_agent": request.headers.get("user-agent"),
                "request_data": request.body
            },
            timeout=5
        )
        
        # 3. Evaluar respuesta
        if response.status_code != 200:
            return JSONResponse(
                status_code=response.status_code,
                content=response.json()
            )
        
        validation_result = response.json()
        
        # 4. Si est√° autorizado, continuar
        if validation_result["authorized"]:
            # Pasar informaci√≥n del usuario al request
            request.state.user = validation_result["user"]
            request.state.permissions = validation_result["user"]["permissions"]
            return await request.next()
        else:
            return JSONResponse(
                status_code=403,
                content={"error": "Unauthorized"}
            )
```

---

## üìà VENTAJAS DE JANO CENTRALIZADO

| Aspecto | Actual (Distribuido) | Con JANO (Centralizado) |
|--------|----------------------|------------------------|
| **Consistencia** | ‚ùå Cada MS valida diferente | ‚úÖ Una √∫nica fuente de verdad |
| **Mantenimiento** | ‚ùå Actualizar reglas en N MS | ‚úÖ Cambiar en 1 lugar (JANO) |
| **Cach√©** | ‚ùå Cach√© duplicado | ‚úÖ Cach√© centralizado (10min) |
| **Rate limiting** | ‚ùå Por MS | ‚úÖ Global por IP |
| **Auditor√≠a** | ‚ùå Dispersa | ‚úÖ Centralizada en jano_rule_violations |
| **Performance** | ‚ùå M√°s lento (validaciones distribuidas) | ‚úÖ R√°pido (cach√© compartido) |
| **Escalabilidad** | ‚ùå Dif√≠cil agregar nuevas reglas | ‚úÖ F√°cil (solo en JANO) |
| **Seguridad** | ‚ùå Vulnerable a bypasses | ‚úÖ M√°s seguro (punto √∫nico) |

---

## üöÄ IMPLEMENTACI√ìN PASO A PASO

### Paso 1: Crear `configuration_rules_microservice`
```
Hacer un nuevo microservicio que sea JANO
Puerto: 8002
```

### Paso 2: En cada MS (Auth, Users, OTP, Management)
```python
# En middleware o en el inicio de cada endpoint
1. Extraer token del header
2. Llamar a JANO con: token, endpoint, m√©todo, IP
3. Si JANO retorna authorized=true ‚Üí continuar
4. Si no ‚Üí retornar error 401/403/429
```

### Paso 3: Configurar en docker-compose.yml
```yaml
jano_microservice:
  build: ./configuration_rules_microservice
  ports:
    - "8002:8002"
  depends_on:
    - postgres
    - auth_microservice
  environment:
    - DATABASE_URL=postgresql://...
    - CACHE_TYPE=redis  # o in-memory
    - JWT_PUBLIC_KEY=...
```

### Paso 4: Actualizar reglas en BD
```sql
-- Insertar en jano_security_rules
INSERT INTO jano_security_rules (...) VALUES (...);

-- Insertar en module_permissions
INSERT INTO module_permissions (...) VALUES (...);
```

---

## üìä DIAGRAMA DE CAPAS

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         CLIENTE (Frontend/App)              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚îÇ HTTP Request
                     ‚îÇ + JWT Token
                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Auth MS ‚îÇ Users MS ‚îÇ OTP MS ‚îÇ Mgmt MS     ‚îÇ
‚îÇ  (8001)  ‚îÇ  (8006)  ‚îÇ (8003) ‚îÇ   (8005)    ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  Cada MS env√≠a petici√≥n a JANO              ‚îÇ
‚îÇ  (Antes de procesar)                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ            ‚îÇ        ‚îÇ
             ‚îÇ Valida     ‚îÇ Valida ‚îÇ Valida
             ‚îÇ            ‚îÇ        ‚îÇ
             ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ            ‚îÇ
                  ‚ñº            ‚ñº
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ   JANO Microservice (8002)  ‚îÇ
        ‚îÇ   - JWT validation          ‚îÇ
        ‚îÇ   - Authorization           ‚îÇ
        ‚îÇ   - Rate limiting           ‚îÇ
        ‚îÇ   - Auditor√≠a               ‚îÇ
        ‚îÇ   - Cach√© (10 min)          ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚îÇ Lee/Escribe
                     ‚ñº
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ     PostgreSQL (siata_auth)  ‚îÇ
        ‚îÇ                             ‚îÇ
        ‚îÇ  - users                    ‚îÇ
        ‚îÇ  - auth_tokens              ‚îÇ
        ‚îÇ  - jano_security_rules      ‚îÇ
        ‚îÇ  - jano_rule_violations     ‚îÇ
        ‚îÇ  - sessions                 ‚îÇ
        ‚îÇ  - teams                    ‚îÇ
        ‚îÇ  - module_permissions       ‚îÇ
        ‚îÇ  - applications             ‚îÇ
        ‚îÇ  - modules                  ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéØ CONFIGURACI√ìN DE REGLAS EN JANO

### Ejemplo de Regla: Rate Limiting
```sql
INSERT INTO jano_security_rules (
  rule_name,
  rule_type,
  rule_code,
  description,
  rule_config,
  severity,
  priority,
  is_active,
  applies_to_roles
) VALUES (
  'Rate limiting de API',
  'rate_limit',
  'RATE_LIMIT_001',
  'M√°ximo 100 requests por minuto por IP',
  '{
    "requests_per_minute": 100,
    "burst_size": 150,
    "block_duration_minutes": 15
  }',
  'high',
  120,
  true,
  NULL  -- Aplica a todos los roles
);
```

### Ejemplo de Regla: Authorization por Endpoint
```sql
INSERT INTO jano_security_rules (
  rule_name,
  rule_type,
  rule_code,
  description,
  rule_config,
  severity,
  applies_to_endpoints
) VALUES (
  'Acceso a /api/tasks',
  'authorization',
  'AUTH_ENDPOINT_001',
  'Solo root y user_siata pueden acceder a /api/tasks',
  '{
    "endpoint": "/api/tasks",
    "method": "GET",
    "allowed_roles": ["root", "user_siata"],
    "required_groups": []
  }',
  'high',
  NULL,
  '{/api/tasks*}'
);
```

---

## üîê FLUJO COMPLETO DETALLADO

```
CLIENTE env√≠a:
GET /api/users/1
Authorization: Bearer eyJhbGc...
IP: 192.168.1.100

‚îÇ
‚ñº
USERS MICROSERVICE (8006)
‚îú‚îÄ> Intercepta petici√≥n
‚îú‚îÄ> Extrae token: eyJhbGc...
‚îú‚îÄ> Extrae endpoint: /api/users/1
‚îú‚îÄ> Extrae IP: 192.168.1.100
‚îú‚îÄ> LLAMA A JANO:
‚îÇ   POST http://jano_microservice:8002/api/validate
‚îÇ   {
‚îÇ     "token": "eyJhbGc...",
‚îÇ     "endpoint": "/api/users/1",
‚îÇ     "method": "GET",
‚îÇ     "ip_address": "192.168.1.100",
‚îÇ     "user_agent": "Mozilla/..."
‚îÇ   }
‚îÇ
‚ñº
JANO MICROSERVICE (8002)
‚îú‚îÄ> ETAPA 1: VALIDA TOKEN
‚îÇ   ‚îú‚îÄ> Decodifica JWT
‚îÇ   ‚îú‚îÄ> Verifica firma contra public key
‚îÇ   ‚îú‚îÄ> Comprueba exp (no est√© expirado)
‚îÇ   ‚îú‚îÄ> Consulta BD: ¬øest√° revocado?
‚îÇ   ‚îî‚îÄ> ‚úÖ PASS
‚îÇ
‚îú‚îÄ> ETAPA 2: VALIDA AUTORIZACI√ìN
‚îÇ   ‚îú‚îÄ> Consulta jano_security_rules
‚îÇ   ‚îú‚îÄ> Busca regla que mapee: /api/users/* + GET
‚îÇ   ‚îú‚îÄ> Obtiene user_id del token
‚îÇ   ‚îú‚îÄ> Consulta usuarios: role y grupos
‚îÇ   ‚îú‚îÄ> Valida: ¬ørol/grupos coinciden con regla?
‚îÇ   ‚îî‚îÄ> ‚úÖ PASS
‚îÇ
‚îú‚îÄ> ETAPA 3: EVAL√öA REGLAS ADICIONALES
‚îÇ   ‚îú‚îÄ> Rate limit:
‚îÇ   ‚îÇ   ‚îú‚îÄ> Consulta cach√©: rate_limit:192.168.1.100
‚îÇ   ‚îÇ   ‚îú‚îÄ> Si no existe ‚Üí crea: {"requests": 1, "window_end": T+60s}
‚îÇ   ‚îÇ   ‚îú‚îÄ> Si existe ‚Üí incrementa: {"requests": 96, "window_end": T+30s}
‚îÇ   ‚îÇ   ‚îú‚îÄ> ¬ø96 < 100? ‚Üí ‚úÖ OK
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ> IP whitelist: (si est√° configurada)
‚îÇ   ‚îÇ   ‚îú‚îÄ> ¬ø192.168.1.100 en whitelist?
‚îÇ   ‚îÇ   ‚îî‚îÄ> ‚úÖ OK
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ> MFA required:
‚îÇ   ‚îÇ   ‚îú‚îÄ> ¬øUsuario es root?
‚îÇ   ‚îÇ   ‚îú‚îÄ> ¬øTiene MFA habilitado?
‚îÇ   ‚îÇ   ‚îî‚îÄ> ‚úÖ OK
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ> Otras reglas...
‚îÇ
‚îú‚îÄ> ‚úÖ RETORNA AL USERS MS:
‚îÇ   {
‚îÇ     "authorized": true,
‚îÇ     "user": {
‚îÇ       "user_id": "78de8e0b-...",
‚îÇ       "username": "juan.perez",
‚îÇ       "email": "juan.perez@siata.gov.co",
‚îÇ       "role": "user_siata",
‚îÇ       "groups": ["hidrologia"],
‚îÇ       "permissions": ["read", "write"]
‚îÇ     },
‚îÇ     "validation_stages": [
‚îÇ       {"stage": "authentication", "result": "PASS"},
‚îÇ       {"stage": "authorization", "result": "PASS"},
‚îÇ       {"stage": "rules", "result": "PASS"}
‚îÇ     ]
‚îÇ   }
‚îÇ
‚ñº
USERS MICROSERVICE (8006) - Contin√∫a
‚îú‚îÄ> Recibe respuesta de JANO
‚îú‚îÄ> ¬øauthorized === true? ‚Üí ‚úÖ YES
‚îú‚îÄ> Procede con l√≥gica de negocio
‚îú‚îÄ> Consulta BD: SELECT * FROM users WHERE user_id = 1
‚îú‚îÄ> Retorna datos al cliente
‚îÇ
‚ñº
CLIENTE recibe:
{
  "user_id": 1,
  "name": "Juan P√©rez",
  "email": "juan.perez@siata.gov.co",
  "role": "user_siata"
}
```

---

## üéì RESUMEN EN PUNTOS CLAVE

‚úÖ **JANO es un microservicio independiente** que:
1. Valida JWT tokens
2. Verifica autorizaci√≥n (roles, permisos, grupos)
3. Eval√∫a reglas de seguridad
4. Implementa rate limiting
5. Registra violaciones
6. Cachea decisiones (10 minutos)

‚úÖ **Todos los MS consultan a JANO** antes de procesar:
- Auth MS ‚Üí Consulta JANO
- Users MS ‚Üí Consulta JANO
- OTP MS ‚Üí Consulta JANO
- Management MS ‚Üí Consulta JANO

‚úÖ **Las reglas se configuran en 1 solo lugar**: Base de datos

‚úÖ **El cach√© es compartido**: 10 minutos TTL

‚úÖ **Es transversal y reutilizable**: Se aplica a todo

---

**Esto es exactamente lo que Carolina explicaba en su presentaci√≥n** üéØ

Se puede implementar como `configuration_rules_microservice` que act√∫e como **JANO centralizado**.
