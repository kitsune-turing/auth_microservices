# Users Microservice - JANO Integration

**Status**: ‚úÖ COMPLETED  
**Date**: 2024  
**Version**: 2.1.0  

## Overview

El microservicio de usuarios ha sido actualizado para integrar validaci√≥n de pol√≠ticas de seguridad con JANO (Configuration Rules Microservice). Todas las contrase√±as y nombres de usuario son validados contra las pol√≠ticas de seguridad antes de crear usuarios.

## Cambios Implementados

### üì¶ Archivos Creados (1)

#### 1. JANO Client
- `src/infrastructure/adapters/jano_client.py` (~250 l√≠neas)
  - **JANOClient**: Cliente HTTP async para comunicaci√≥n con JANO
  - **JANOValidationError**: Excepci√≥n personalizada con violaciones
  - **M√©todos**:
    * `validate_password()` - Valida contrase√±a contra pol√≠ticas
    * `validate_username()` - Valida nombre de usuario
    * `health_check()` - Verifica disponibilidad de JANO
  - **Global instance**: `jano_client` inicializado en lifespan

### üîß Archivos Modificados (4)

#### 1. Create User Use Case
**Archivo**: `src/application/use_cases/create_user_use_case.py`

**Cambios**:
- ‚úÖ Agregado par√°metro `jano_client: JANOClient` en constructor
- ‚úÖ Validaci√≥n de username con JANO (paso 1)
- ‚úÖ Validaci√≥n de password con JANO (paso 2)
- ‚úÖ Manejo de `JANOValidationError` con violaciones detalladas

**Flujo actualizado**:
```python
1. Validate username ‚Üí JANO
2. Validate password ‚Üí JANO (with username context)
3. Check user exists ‚Üí Database
4. Hash password ‚Üí BCrypt
5. Create user ‚Üí Database
```

#### 2. Dependencies
**Archivo**: `src/infrastructure/config/dependencies.py`

**Cambios**:
- ‚úÖ Import de `get_jano_client` y `JANOClient`
- ‚úÖ Actualizado `get_create_user_use_case()`:
  ```python
  jano_client = get_jano_client()
  return CreateUserUseCase(user_repository, password_service, jano_client)
  ```

#### 3. User Controller
**Archivo**: `src/infrastructure/adapters/controllers/user_controller.py`

**Cambios**:
- ‚úÖ Import de `JANOValidationError`
- ‚úÖ Manejo de excepciones en `create_user()`:
  ```python
  except JANOValidationError as e:
      raise HTTPException(
          status_code=400,
          detail={
              "message": e.message,
              "violations": e.violations
          }
      )
  ```

#### 4. Main Application
**Archivo**: `main.py`

**Cambios**:
- ‚úÖ Import de `jano_client_module` y `JANOClient`
- ‚úÖ Inicializaci√≥n de JANO client en lifespan:
  ```python
  jano_service_url = os.getenv("JANO_SERVICE_URL", "http://jano_microservice:8005")
  jano_client_module.jano_client = JANOClient(
      base_url=jano_service_url,
      timeout=5.0,
      application_id="users_service"
  )
  ```
- ‚úÖ Health check de JANO en startup
- ‚úÖ Cierre de cliente en shutdown

#### 5. Docker Compose
**Archivo**: `docker-compose.yml`

**Cambios**:
- ‚úÖ Agregada variable de entorno `JANO_SERVICE_URL`
- ‚úÖ Agregada dependencia de `jano_microservice`

### üìù Archivos de Testing (1)

- `test/manual_test_users_jano.py` (~330 l√≠neas)
  - 6 tests de integraci√≥n
  - Autenticaci√≥n como ROOT
  - Validaci√≥n de passwords JANO-compliant
  - Validaci√≥n de rechazo por pol√≠ticas
  - Test de duplicados

## Validaciones JANO

### Password Validation

El cliente JANO valida contrase√±as contra las siguientes pol√≠ticas:

1. **Longitud m√≠nima**: 8 caracteres (configurable)
2. **Complejidad requerida**:
   - Al menos 1 may√∫scula
   - Al menos 1 min√∫scula
   - Al menos 1 n√∫mero
   - Al menos 1 car√°cter especial
3. **Patrones prohibidos**:
   - No puede contener el username
   - No puede ser una contrase√±a com√∫n
4. **Historial**: No puede reutilizar contrase√±as recientes

### Username Validation

El cliente JANO valida usernames contra:

1. **Longitud**: 3-50 caracteres (configurable)
2. **Caracteres permitidos**: Alfanum√©ricos y guion bajo
3. **Patrones**: No puede contener palabras reservadas

## API Changes

### POST /api/users (Create User)

**Request** (sin cambios):
```json
{
  "username": "newuser",
  "email": "newuser@siata.gov.co",
  "password": "SecureP@ss123",
  "name": "New",
  "last_name": "User",
  "role": "USER",
  "team_name": "Development"
}
```

**Response 201 - Success** (sin cambios):
```json
{
  "id": "123e4567-e89b-12d3-a456-426614174000",
  "username": "newuser",
  "email": "newuser@siata.gov.co"
}
```

**Response 400 - JANO Validation Failed** (NUEVO):
```json
{
  "detail": {
    "message": "Password does not meet security requirements: ...",
    "violations": [
      "Password must be at least 8 characters long",
      "Password must contain at least one uppercase letter",
      "Password must contain at least one special character"
    ]
  }
}
```

**Response 409 - Duplicate User**:
```json
{
  "detail": "Username or email already exists"
}
```

## Configuration

### Environment Variables

```yaml
# docker-compose.yml - users_microservice
environment:
  # Database
  DATABASE_URL: postgresql+asyncpg://admin:password@postgres:5432/auth_login_services
  
  # Services
  AUTH_SERVICE_URL: http://auth_microservice:8001
  JANO_SERVICE_URL: http://jano_microservice:8005  # NEW
  
  # Service
  SERVICE_PORT: 8006

depends_on:
  postgres:
    condition: service_healthy
  jano_microservice:  # NEW
    condition: service_started
```

### JANO Client Configuration

```python
JANOClient(
    base_url="http://jano_microservice:8005",
    timeout=5.0,  # 5 seconds
    application_id="users_service"  # Identifies this service in JANO
)
```

## Error Handling

### JANO Service Unavailable

Si JANO no est√° disponible durante el startup:
- ‚ö†Ô∏è  Warning logged
- ‚úÖ Service contin√∫a arrancando
- ‚ùå Creaci√≥n de usuarios fallar√° con error de timeout

### JANO Validation Timeout

```python
try:
    is_valid, violations = await jano_client.validate_password(...)
except JANOValidationError as e:
    # e.message: "Password validation service timeout"
    # e.violations: ["Service temporarily unavailable"]
```

### JANO Communication Error

```python
try:
    is_valid, violations = await jano_client.validate_password(...)
except JANOValidationError as e:
    # e.message: "Unable to validate password"
    # e.violations: ["Service communication error"]
```

## Testing

### Manual Tests

```bash
# Asegurar que los servicios est√©n corriendo
docker-compose up -d postgres jano_microservice auth_microservice users_microservice

# Ejecutar tests
cd users_microservice
python test/manual_test_users_jano.py
```

### Expected Test Results

1. ‚úÖ Health Check
2. ‚úÖ Create User with Valid Password (JANO compliant)
3. ‚úÖ Get User by ID
4. ‚úÖ Weak Password Rejection (JANO validation)
5. ‚úÖ Invalid Username Rejection (JANO validation)
6. ‚úÖ Duplicate User Rejection

### Test Scenarios

#### Scenario 1: Valid Password
```python
{
  "username": "testuser001",
  "password": "SecureP@ss123",  # ‚úÖ Meets all requirements
  ...
}
# Expected: 201 Created
```

#### Scenario 2: Weak Password
```python
{
  "username": "weakuser001",
  "password": "weak",  # ‚ùå Too short, no uppercase, no special char
  ...
}
# Expected: 400 Bad Request with JANO violations
```

#### Scenario 3: Invalid Username
```python
{
  "username": "ab",  # ‚ùå Too short (< 3 chars)
  "password": "ValidP@ss123",
  ...
}
# Expected: 400 Bad Request with JANO violations
```

## Security Benefits

### Before JANO Integration
- ‚ùå No password policy enforcement
- ‚ùå Weak passwords accepted
- ‚ùå No username validation
- ‚ùå Inconsistent security across services

### After JANO Integration
- ‚úÖ Centralized password policies
- ‚úÖ Strong passwords enforced
- ‚úÖ Username validation
- ‚úÖ Consistent security rules
- ‚úÖ Configurable policies
- ‚úÖ Audit trail via JANO

## BCrypt Password Hashing

El microservicio utiliza BCrypt para hashing de contrase√±as:

```python
class BcryptPasswordService(PasswordServicePort):
    def __init__(self, rounds: int = 12):
        self.rounds = rounds  # Cost factor
    
    def hash_password(self, password: str) -> str:
        password_bytes = password.encode('utf-8')
        salt = bcrypt.gensalt(rounds=self.rounds)
        hashed = bcrypt.hashpw(password_bytes, salt)
        return hashed.decode('utf-8')
    
    def verify_password(self, password: str, hashed: str) -> bool:
        password_bytes = password.encode('utf-8')
        hashed_bytes = hashed.encode('utf-8')
        return bcrypt.checkpw(password_bytes, hashed_bytes)
```

**Caracter√≠sticas**:
- ‚úÖ BCrypt con rounds=12 (configurable)
- ‚úÖ Salt autom√°tico por hash
- ‚úÖ Resistente a ataques de fuerza bruta
- ‚úÖ Timing attack resistant

## ROOT-Only Access

Todas las operaciones de usuarios requieren rol ROOT:

```python
@router.post(
    "",
    dependencies=[Depends(require_root_role)],  # ROOT only
)
async def create_user(...):
    ...
```

**Endpoints Protegidos**:
- ‚úÖ `POST /api/users` - Create user
- ‚úÖ `GET /api/users/{user_id}` - Get user
- ‚úÖ `PUT /api/users/{user_id}` - Update user
- ‚úÖ `PATCH /api/users/{user_id}/disable` - Disable user
- ‚úÖ `PATCH /api/users/{user_id}/enable` - Enable user

**Endpoints Internos** (sin autenticaci√≥n):
- `/internal/users/validate-credentials` - Para auth_microservice
- `/internal/users/validate-credentials-email` - Para auth_microservice
- `/internal/users/{user_id}` - Para auth_microservice

## Integration Flow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ROOT Client    ‚îÇ
‚îÇ (with JWT)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ POST /api/users
         ‚îÇ {username, password, ...}
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Users Microservice         ‚îÇ
‚îÇ                             ‚îÇ
‚îÇ  1. Auth Middleware         ‚îÇ
‚îÇ     ‚îî‚îÄ> Verify ROOT role    ‚îÇ
‚îÇ                             ‚îÇ
‚îÇ  2. Create User Use Case    ‚îÇ
‚îÇ     ‚îú‚îÄ> Validate username ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îê
‚îÇ     ‚îÇ                       ‚îÇ  ‚îÇ
‚îÇ     ‚îú‚îÄ> Validate password ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚î§
‚îÇ     ‚îÇ                       ‚îÇ  ‚îÇ
‚îÇ     ‚îú‚îÄ> Check duplicates    ‚îÇ  ‚îÇ
‚îÇ     ‚îú‚îÄ> Hash password       ‚îÇ  ‚îÇ
‚îÇ     ‚îî‚îÄ> Save to DB          ‚îÇ  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
                                 ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  JANO Microservice          ‚îÇ
‚îÇ                             ‚îÇ
‚îÇ  - Validate username        ‚îÇ
‚îÇ  - Validate password        ‚îÇ
‚îÇ  - Check policies           ‚îÇ
‚îÇ  - Return violations        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## Monitoring & Logging

El servicio registra:

```python
# Startup
logger.info(f"JANO client initialized with URL: {jano_service_url}")
logger.info("‚úÖ JANO service is available")

# Validation
logger.debug(f"Validating username with JANO: {username}")
logger.debug(f"Validating password with JANO for user: {username}")

# Success
logger.info(f"User created successfully: {username} (id={user_id}) [JANO validated]")

# Failures
logger.warning(f"Username validation failed: {username}. Violations: {violations}")
logger.warning(f"Password validation failed: {username}. Violations: {violations}")

# Errors
logger.error(f"JANO password validation timeout after {timeout}s")
logger.error(f"JANO password validation HTTP error: {error}")
```

## Pr√≥ximos Pasos

- [ ] Implementar cambio de contrase√±a con validaci√≥n JANO
- [ ] Validar contrase√±as en update de usuario
- [ ] Agregar rate limiting para creaci√≥n de usuarios
- [ ] M√©tricas de validaciones JANO (Prometheus)
- [ ] Dashboard de pol√≠ticas de seguridad
- [ ] Tests de integraci√≥n automatizados

## Referencias

- **JANO Client**: `src/infrastructure/adapters/jano_client.py`
- **Create User Use Case**: `src/application/use_cases/create_user_use_case.py`
- **User Controller**: `src/infrastructure/adapters/controllers/user_controller.py`
- **Manual Tests**: `test/manual_test_users_jano.py`
- **Password Service**: `src/infrastructure/adapters/services/password_service.py`

---

**Integration Status**: ‚úÖ COMPLETED  
**Next Task**: Task 7 - Implementar management_application_microservice
